---
title: "Investigating Fire Incidents Severity Levels in Toronto: Enhancing Resource Allocation for Fire Response"
subtitle: "Identifying Key Factors for Fire Severity and Evaluating the Effectiveness of Public Fire Response Systems"
author: 
  - Maggie Zhang
thanks: "Code and data are available at: [https://github.com/MaggieZ111119/TFS_Toronto_Fire_Incident](https://github.com/MaggieZ111119/TFS_Toronto_Fire_Incident)."
date: "December 3, 2024"
date-format: long
abstract: "This study investigates fire severity levels in Toronto to improve resource allocation for Toronto Fire Services (TFS). The analysis identifies that higher-severity incidents are strongly correlated with incidents originating from mechanical, HVAC, and electrical areas, while cooking and lighting areas tend to lead to lower severity fires. The study also finds that fire incidents involving certain ignition sources, such as electrical units or lightning equipment, are more likely to be severe. The study also evaluates the effectiveness of public fire response systems, highlighting that fire alarms are successful in low and medium-severity fires, while sprinkler systems are often only partially operational. Results can guide TFS to enhance response times, prioritize resources, and optimize fire response operations, ultimately improving community safety in Toronto."
format: pdf
number-sections: true
toc: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false
library(tidyverse)
library(dplyr)
library(ggplot2)
library(tidyr)
library(lubridate)
library(knitr)
library(arrow)


fire_data <- read_parquet(file = here::here("data/02-analysis_data/tfs_analysis_data.parquet"))


```

# Introduction

The study aims to estimate the severity of fires in the Toronto region. A fire incident, as defined by the Ontario Fire Marshal (OFM), refers to any event involving fire, explosion, or other situations suspected to lead to significant outcomes, such as injury or death [@ontario_fire_marshal].

The severity of a fire can be assessed through various factors, including the intensity of the flames, the size of the affected area, the duration of the fire, its impact on human activities, and its potential threat to animal habitats. There are numerous standards and considerations when discussing fire severity, but when it comes to prediction, it is unrealistic to consider all factors. Therefore, defining severity becomes the first task before any further analysis. In this paper, the severity of a fire is defined based on three aspects: casualty and financial loss, the type of incident, and the number of apparatuses dispatched by Toronto Fire Services (TFS) in response to the fire. Further explanation of how severity is defined will be provided later in the paper.

This research also identifies specific high-priority response criteria that can enhance TFS operations. By examining the data, it has been found that the area of origin of a fire is a significant predictor of fire severity. Fires originating from mechanical, HVAC, and electrical areas are highly correlated with severe incidents, whereas fires originating from cooking and heating areas are more commonly associated with low-severity incidents.

Additionally, beyond investigating potential predictors of severe fire incidents, this study also explores the effectiveness of current public fire response mechanisms, such as fire alarms and sprinkler systems, in the Toronto region. It was discovered that sprinkler systems, across all levels of fire severity, were largely only partially operational. On the other hand, fire alarm systems were successfully activated in low and medium-severity fire incidents.

The Office of the Fire Marshal (OFM) plays a crucial role in overseeing fire safety regulations in Ontario, ensuring fire protection, prevention, and public safety across the province. They are responsible for setting safety standards and improving public safety for all municipalities. Under the leadership of the OFM, municipal fire departments, such as Toronto Fire Services (TFS), allocate resources and develop plans to protect shared communities [@ontario_fire_marshal]. Therefore, by analyzing data within their standards, identifying factors that contribute to high-risk fire incidents, and evaluating current operational mechanisms, TFS can gain valuable insights to develop strategic response protocols that prioritize these incidents. This knowledge will help both the public and fire departments enhance response times, allocate resources more effectively, and reduce the occurrence of lower-severity incidents.

The remainder of this paper is structured as follows. [@sec-data] describes the data used in the analysis, including the sources and key variables and their visualizations.[@sec-model] outlines the models applied to estimate fire severity and identify key factors. [@sec-results] presents the results of the analysis. [@sec-discussion] provides an interpretation of the results in the context of current fire safety practices and suggests potential improvements. Finally, [@sec-appendix] includes supplementary information and additional data details.

In this paper, I used several R packages for data analysis and visualization. The `tidyverse`[@wickham2023tidyverse], `dplyr`[@wickham2023dplyr], and `tidyr`[@wickham2023tidyr] were used for data manipulation. `ggplot2`[@wickham2016ggplot2] facilitated data visualization, while `lubridate`[@grolemund2011lubridate] was used for date-time handling. `knitr`[@xie2023knitr] helped integrate code into reports. For modeling, I used `rstanarm`[@gelman2020rstanarm] and `modelsummary`[@fox2021modelsummary] for summaries, `caret`[@kuhn2023caret] for model training, and `xgboost`[@chen2016xgboost] for boosting. Additional tools like `rpart`[@therneau2015rpart], `fitdistrplus`[@delignette-muller2023fitdistrplus], and `pROC`[@robin2023pROC] supported partitioning, distribution fitting, and model evaluation.

# Data {#sec-data}

## Overview

We use the statistical programming language R [@citeR]to investigate data about fire incidents[@TFSfireedata], downloaded from the Open Data Toronto Portal: https://open.toronto.ca/dataset/fire-incidents/ . The dataset was last updated on December 31, 2023. It includes fire incidents following the Ontario Fire Marshal's (OFM) definition, with descriptions according to OFM standards. The dataset also provides detailed information on Toronto Fire Services' (TFS) responses to each fire incident. The data is mostly complete, though some incidents are still under investigation and categorized as "no loss outdoor fire." The dataset includes information on the origin of fires, impacts on civilians and buildings, as well as geographical data (see @tbl-preview-data). Additionally, it contains details on TFS response times and actions taken. Overall, the dataset is comprehensive, informative, and provides valuable insights for my later study.

```{r}
#| label: tbl-preview-data
#| tbl-cap: Preview of the Fire Incident data (https://open.toronto.ca/dataset/fire-incidents/) before cleaning, displaying the first six rows with columns decided first in interested for study.
#| echo: false
#| warning: false

library(tidyverse)
library(dplyr)
library(lubridate)
library(kableExtra)

#### Load original data ####
raw_data <- read_csv(file = here::here("data/01-raw_data/raw_fire_data.csv"))

columns_to_keep <- c("_id", "Area_of_Origin", "Building_Status", "Business_Impact", 
                     "Civilian_Casualties", "Estimated_Dollar_Loss", "Exposures", 
                     "Final_Incident_Type", "Fire_Alarm_System_Operation", 
                     "Ignition_Source",
                     "Number_of_responding_apparatus", "Number_of_responding_personnel", 
                     "Possible_Cause", "Sprinkler_System_Presence", 
                     "TFS_Alarm_Time", "TFS_Arrival_Time", "TFS_Firefighter_Casualties")

clean_data <- raw_data[, columns_to_keep]
# Change columns name to lower case and ensure no space
colnames(clean_data) <- tolower(gsub(" ", "_", colnames(clean_data)))

### Preview data ###
head_table <- head(clean_data)
kable(head(head_table)) |>
  kable_styling(latex_options = c("scale_down"))

```

## Measurement

The dataset is clearly structured, with the first column as ‘\_id,’ which is a unique identifier for each record in the database. There are 43 columns in total, containing information ranging from Incident Type to Infrastructure. These columns can be mainly divided into four categories based on my understanding:

1.  **Incident Type and Cause**: This category contains information directly related to each fire incident, including descriptive details about the incident, its nature, and origin. It covers aspects such as where the fire started, the materials involved, and potential causes. These variables are crucial for predicting fire behavior, and include columns like 'area of origin,' 'level of origin,' and 'smoke spread.'

2.  **Impact on Humans and the Economy**: These variables describe the direct outcomes of fire incidents, including financial and environmental impacts, as well as effects on human life. This category is key for defining the severity of fires. Variables include: firefighter casualties, civilian casualties, building status after the fire, and the number of displaced people.

3.  **Response Evaluation**: This category records TFS's reactions to each reported fire incident. It provides valuable insight into the effectiveness of the current system and helps when predicting fire severity. Variables include: 'fire control time,' 'incident location,' 'number of responding personnel,' and 'TFS arrival times.'

4.  **Safety Infrastructure**: This category includes data related to the status of existing infrastructure during the fire incident. It helps us understand the current system and supports decision-making for future improvements. Variables include: presence of fire alarm systems, sprinkler systems, and their operational status.

This structured approach allows us to analyze and understand various aspects of fire incidents in Toronto. All variables in the dataset have the potential to provide valuable insights and perspectives for various analyses, contributing to fire prevention and safety improvements. However, for my analysis of fire incidents across Toronto, certain variables; such as latitude and longitude, incident numbers in the CAD system, Incident_Ward, and road intersections—are being excluded from the study. A more detailed explanation will be provided in the @sec-appendix.

I have selected 17 variables to begin my exploration of the dataset:

1.  **\_id**: A unique identifier for each record, essential for distinguishing between incidents and for tracking and referencing.

2.  **Area_of_Origin**: Represents the fire’s origin location, useful for analyzing geographical patterns and fire causes.

3.  **Building_Status**: Indicates whether the building was occupied, under construction, or vacant, providing insights into fire severity and response needs.

4.  **Business_Impact**: Classifies the economic impact of the fire on businesses, helping to understand disruptions and guide recovery efforts.

5.  **Civilian_Casualties**: The count of civilian casualties, reflecting the human impact and assessing fire safety and evacuation effectiveness.

6.  **Estimated_Dollar_Loss**: The monetary loss due to fire damage, key for assessing the economic burden and informing prevention efforts.

7.  **Exposures**: The number of secondary fires caused by the primary incident, useful for evaluating the fire's spread and containment success.

8.  **Final_Incident_Type**: The final classification of the fire (e.g., accidental, arson), critical for identifying causes and informing preventive strategies.

9.  **Fire_Alarm_System_Operation**: Indicates whether the fire alarm system functioned properly, evaluating the system’s effectiveness in alerting and activating suppression.

10. **Ignition_Source**: The source of ignition (e.g., electrical faults, arson), crucial for identifying fire causes and guiding safety measures.

11. **Number_of_Responding_Appliances**: The number of fire trucks and equipment dispatched, reflecting the scale of the incident and resource allocation.

12. **Number_of_Responding_Personnel**: The number of fire personnel involved, providing insight into the severity of the fire and the required response intensity.

13. **Possible_Cause**: The potential cause of the fire, useful for identifying trends and informing fire prevention and safety campaigns.

14. **Sprinkler_System_Presence**: Indicates if a sprinkler system was present, highlighting its impact on fire severity and potential casualties.

15. **TFS_Alarm_Time**: The time when the fire service was notified, key for analyzing response time and minimizing damage.

16. **TFS_Arrival_Time**: The time when the first fire service unit arrived, crucial for evaluating response speed and fire control effectiveness.

17. **TFS_Firefighter_Casualties**: The number of firefighter casualties, useful for assessing the safety of firefighting operations and improving risk management.

By focusing on these 17 variables, I aim to uncover meaningful patterns and insights that can support fire safety improvements across the city.

## Data Cleaning

The raw dataset was stored in its original csv format to ensure data integrity and reproducibility, and later analysis data after cleaning and processing is saved into parquet file using `write_parquet` function in `arrow` package [@arrow2024].

After loading the original raw data, I selected the columns of interest as explained in the previous section. These columns were then renamed to lowercase, and spaces were replaced with underscores to ensure consistency. After reviewing the data, I kept in mind that this study focuses on the relationship between ignition sources and fire severity. As a result, I removed rows with "Undetermined" ignition sources.

Since there are time-related variables in the dataset, I converted them to the POSIX format. Additionally, I noticed the presence of several missing (NA) and null values. Given that the dataset contains numerous categorical variables, I considered how to handle missing data differently for these types. I first examined whether any columns contained too little information to provide valuable insights into fire severity or its predictors. After calculating, I decided to remove columns with more than 20% missing data, carefully considering their relevance to the study.

To maintain data quality, rows with more than 30% missing data are removed. After ensuring that there are no missing values in the dataset, a new variable, Response_Time, is created to calculate the time difference (in minutes) between TFS_Alarm_Time and TFS_Arrival_Time (see @fig-response-time-distribution). This new variable will help analyze fire response efficiency and is a key indicator for the study.

```{r}
#| label: fig-response-time-distribution
#| fig-cap: Distribution of response times for fire incidents in Toronto, showing the frequency of various response times (in minutes). This visualization highlights the efficiency of the Toronto Fire Service's (TFS) response. It's almost normally distributed with a mean of around 5, and the spread of not too far.
#| echo: false
#| warning: false
library(ggplot2)
library(arrow)
fire_data <- read_parquet(here::here("data/02-analysis_data/tfs_analysis_data.parquet"))
## 15. Response Time (Numerical) ##
#Plot
ggplot(fire_data, aes(x = response_time)) +
  geom_histogram(bins = 30, fill = "lightgreen", color = "black") +
  theme_minimal() +
  ggtitle("Response Time Distribution") +
  xlab("Response Time (minutes)") +
  ylab("Frequency") +
  stat_bin(aes(label = ..count..), geom = "text", vjust = -0.5, size = 3) +
  xlim(0, 15) 

```

## Data Explore

**Understanding Variables of Interest**:\
To understand the distribution of various categorical and numerical variables in the fire incident dataset, I visualized each variable along with its distribution and reviewed its summary statistics. The goal is to gain insights into the key characteristics of the data, which will support the later stages of analysis and modeling. Can check @sec-appendix for visualization/summary of the distribution of all variables. Below are a few important variables considered:

1.  **Area of Origin**:\
    This is a categorical variable that indicates the location within a building or structure where a fire started. Initially, this variable had over 100 categories, so the goal was to categorize these locations into broader groups for easier interpretation and analysis. I grouped the areas into categories such as "Residential and Living Spaces," "Cooking and Dining Areas," and "Storage and Utility Areas," among others. These groups were then visualized to better understand the most common fire origins within the dataset (see @fig-area-origin-distribution). Among all categories, Cooking and Dinning area stands out to be the area which most fire originate from. Living space and Transportation area also has a great amount to incidence occurred.

```{r}
#| label: fig-area-origin-distribution
#| fig-cap: Distribution of the Area of Origin for fire incidents, categorized into various groups such as Residential, Office, Mechanical, and Industrial areas. The plot highlights the frequency of each area category, helping to understand the distribution of fire origins.
#| echo: false
#| warning: false

all_area <- unique(fire_data$area_of_origin)
# List of Area of Origin
area_of_origin <- c("22 - Sleeping Area or Bedroom (inc. patients room, dormitory, etc)", 
                    "55 - Mechanical/Electrical Services Room", 
                    "28 - Office", 
                    "24 - Cooking Area or Kitchen", 
                    "81 - Engine Area", 
                    "25 - Washroom or Bathroom (toilet, restroom/locker room)", 
                    "73 - Parking Area, Parking Lot", 
                    "44 - Trash, Rubbish Storage (inc garbage chute room, garbage/industr", 
                    "50 - Basement/cellar (not partitioned)", 
                    "64 - Porch or Balcony", 
                    "78 - Attached Deck", 
                    "86 - Passenger Area", 
                    "52 - HVAC Equipment Room (furnace room, water heater closet, boiler)", 
                    "21 - Living Area (e.g. living, TV, recreation, etc)", 
                    "61 - Exterior Wall", 
                    "62 - Roof", 
                    "12 - Hallway, Corridor", 
                    "83 - Electrical Systems", 
                    "59 - Utility Shaft (eg. electrical wiring/phone, etc.)", 
                    "79 - Other Outside Area", 
                    "75 - Trash, rubbish area (outside)", 
                    "89 - Other Vehicle Area", 
                    "31 - Process Manufacturing (inc manf, prod assembly, repair)", 
                    "53 - Chimney/Flue Pipe", 
                    "26 - Sauna", 
                    "99 - Undetermined (formerly 98)", 
                    "87 - Trunk/Cargo Area", 
                    "11 - Lobby, Entranceway", 
                    "97 - Other - unclassified", 
                    "67 - Concealed Floor Area", 
                    "58 - Ducting - Exhaust (inc cooking, fumes, etc.)", 
                    "29 - Electronic Equipment", 
                    "51 - Elevator (includes shaft)", 
                    "46 - Product Storage (inc products or materials awaiting manuf, assembly)", 
                    "33 - Laboratory", 
                    "84 - Fuel Systems (eg. fuel tank, etc.)", 
                    "27 - Laundry Area", 
                    "69 - Attic Area", 
                    "45 - Supply Storage Room (inc maintenance/office/document storage, et", 
                    "30 - Sales, Showroom Area", 
                    "42 - Garage", 
                    "66 - Concealed Ceiling Area", 
                    "49 - Other Storage Area", 
                    "13 - Stairway, Escalator", 
                    "39 - Other Functional Area", 
                    "71 - Open Area (inc lawn, field, farmyard, park, playing field, pier)", 
                    "93 - Residential/Business: Other business area", 
                    "72 - Court, Patio, Terrace", 
                    "74 - Storage Area (outside)", 
                    "56 - Conveyor Shaft or Chute (inc dumbwaiter, laundry chute, garbage", 
                    "23 - Dining or Beverage Area (inc mess, canteen, lunchroom, cafeteria", 
                    "92 - Residential/Business: Restaurant area", 
                    "63 - Awning or Canopy", 
                    "68 - Concealed Wall Area", 
                    "41 - Closet (eg. clothes, broom, linen closet, etc.)", 
                    "82 - Running Gear (inc wheels and braking systems, transmission system", 
                    "60 - Other Building Services/Support Facilities", 
                    "85 - Operator/Control Area", 
                    "990 - Under Investigation", 
                    "43 - Locker (apartment storage)", 
                    "57 - Ducting - Heating, Air Conditioning", 
                    "70 - Other Structural Area", 
                    "35 - Performance Area (inc stage, rink, boxing ring, gym floor, altar)", 
                    "65 - Crawl Space (includes sub-structure)", 
                    "91 - Multiple Areas of Origin", 
                    "18 - Covered Court, Atrium, mall concourse", 
                    "36 - Backstage, dressing room", 
                    "32 - Assembly Area (inc school room, spectator area, church, etc)", 
                    "19 - Other Means of Egress", 
                    "47 - Shipping/Receiving/Loading Platform", 
                    "34 - Operating Room, Treatment or Examination Area", 
                    "76 - Fuel Dispensing Area (outside)", 
                    "48 - Records storage area (inc vaults)", 
                    "54 - Incinerator Room")

# Create a function to categorize area of origin
categorize_area_of_origin <- function(area) {
  # Residential and Living Spaces
  if (grepl("Bedroom|Living Area|Dormitory|Hallway|Lobby|Basement|Closet|Sauna", area)) {
    return("Residential and Living Spaces")
  } 
  # Cooking and Dining Areas
  else if (grepl("Kitchen|Dining|Canteen|Lunchroom|Mess", area)) {
    return("Cooking and Dining Areas")
  } 
  # Office and Workspace
  else if (grepl("Office|Workspace|Lobby|Showroom|Laboratory|Assembly Area", area)) {
    return("Office and Workspace")
  } 
  # Mechanical, HVAC, and Electrical Areas
  else if (grepl("Mechanical|Electrical|HVAC|Boiler|Furnace", area)) {
    return("Mechanical, HVAC, and Electrical Areas")
  } 
  # Storage and Utility Areas
  else if (grepl("Storage|Concealed|Shaft|Utility|Warehouse|Garage", area)) {
    return("Storage and Utility Areas")
  } 
  # Outdoor and Exterior Areas
  else if (grepl("Parking|Exterior|Deck|Porch|Lawn|Field|Pier|Terrace", area)) {
    return("Outdoor and Exterior Areas")
  } 
  # Vehicle and Transport Areas
  else if (grepl("Vehicle|Trunk|Cargo|Engine|Garage", area)) {
    return("Vehicle and Transport Areas")
  } 
  # Specialized Rooms
  else if (grepl("Bathroom|Laundry|Shower|Incinerator|Sauna|Elevator", area)) {
    return("Specialized Rooms")
  } 
  # Industrial and Manufacturing Areas
  else if (grepl("Manufacturing|Assembly|Fuel Systems|Conveyor|Chute", area)) {
    return("Industrial and Manufacturing Areas")
  } 
  
  # Public and Performance Spaces
  else if (grepl("Stage|Rink|Gym|Performance|Concourse|Court", area)) {
    return("Public and Performance Spaces")
  } 
  # Miscellaneous and Unclassified
  else {
    return("Miscellaneous and Unclassified")
  }
}
# Apply the categorization function to each area of origin
fire_data$area_of_origin_grouped <- sapply(fire_data$area_of_origin, 
                                           categorize_area_of_origin)
# Plot
ggplot(fire_data, aes(x = area_of_origin_grouped)) +
  geom_bar(fill = "red") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab("Area of Origin") +
  ylab("Frequency") +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5)


```

2.  **Civilian Casualties**:\
    This is a numerical variable that provides insight into the severity of the incidents. Basic descriptive statistics (e.g., mean, median, and range) were calculated using the `summary()` function. Additionally, a scatter plot was created to explore the relationship between the number of civilian casualties and the incident ID (see @tbl-civilian-casualties-summary). We can see that most of the time, there are no casualties. This data set ranges across over 10 years (see @fig-fire-incidents-by-year in @sec-appendix), looking at all levels of casualties, and taking its average over 6 years, we can see that this indicates the city has done a good job in protecting civilians from fire places.

```{r}
#| label: tbl-civilian-casualties-summary
#| tbl-cap: Summary table showing the number of civilian casualties in fire incidents, including the frequency of each casualty count. This table summarizes the distribution of civilian casualties and provides an overview of the impact of fire incidents on civilians.
#| echo: false
#| warning: false
library(knitr)

#Overall Table
civilian_casualties_df <- as.data.frame(table(fire_data$civilian_casualties))
colnames(civilian_casualties_df) <- c("Number_of_Casualties", "Frequency")
kable(civilian_casualties_df)

```

3.  **Final Incident Type**:\
    This is a categorical variable that classifies the type of incident (e.g., fire, explosion). A bar plot was created to visualize the distribution of different incident types.(see @fig-final-incident-type-distribution). It's clear that there are more fire than explotion.

```{r}
#| label: fig-final-incident-type-distribution
#| fig-cap: Bar plot illustrating the distribution of final incident types across fire incidents. The plot presents the frequency of each incident type, with the count displayed on top of the bars. We can see that there is much more fire than explotion.
#| echo: false

ggplot(fire_data, aes(x = final_incident_type)) +
  geom_bar(fill = "purple") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    plot.margin = margin(10, 10, 10, 10)  # Add space around the plot
  ) +
  scale_x_discrete(labels = function(x) sapply(x, function(y) paste(head(strsplit(y, " ")[[1]], 3), collapse = " "))) +
  xlab("Final Incident Type") +
  ylab("Frequency") +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5)

```

4.  **Ignition Source**:\
    This variable provides information about the cause of the fire. Categories of ignition sources, such as "Incandescent Lamp" or "Vehicle - Mechanical," were listed. The distribution of ignition sources was visualized with a bar plot (see @fig-grouped-ignition-source-distribution). We can tell that fire-related and open flame is one of the biggest source of fire incidence; cooking and heating equipment are second place as sources, which align with @fig-area-origin-distribution result, where Ketchen is the place most fire incidence starts off.

```{r}
#| label: fig-grouped-ignition-source-distribution
#| fig-cap: Bar plot illustrating the distribution of grouped ignition sources for fire incidents. The plot categorizes ignition sources into meaningful groups such as Lighting and Electrical Equipment, Cooking and Heating Equipment, and Mechanical Equipment, among others. The frequency of each group is displayed. Fire-related and Open Flame is the bigget ingnition source.
#| echo: false
#| warning: false
all_sources <- unique(fire_data$ignition_source)
ignition_sources <- c("51 - Incandescent Lamp - Light Bulb, Spotlight", 
                      "23 - Distribution Equipment (includes panel boards, fuses, circuit br)", 
                      "41 - Other Heating Equipment", "11 - Stove, Range-top burner", 
                      "82 - Vehicle - Mechanical", "24 - Circuit Wiring - Copper", 
                      "98 - Other", "81 - Vehicle - Electrical", "49 - Other Appliances", 
                      "71 - Smoker's Articles (eg. cigarettes, cigars, pipes already ignited)", 
                      "13 - Microwave", "77 - Matches or Lighters (unable to distinguish)", 
                      "74 - Salamander", "12 - Oven", "47 - Refrigerator, Freezer (includes vending machine)", 
                      "73 - Blow Torch, Bunsen Burner", "72 - Cutting/Welding Equipment", 
                      "21 - Transformer", "55 - Candle", "29 - Extension Cord, Temporary Wiring", 
                      "14 - Open Fired Barbeque - Fixed or Portable", "79 - Other Open Flame Tools/Smokers' Articles", 
                      "84 - Other Mechanical", "36 - Fireplace - Masonry", "83 - Other Electrical", 
                      "20 - Service/Utility Lines (includes power/hydro transmission lines)", 
                      "92 - Open Fire (eg. camp fire, rubbish fire, etc.)", "17 - Wood burning stove", 
                      "62 - Heat Treatment Equipment (eg. furnace, oven, kiln, quench tanks, etc.)", 
                      "19 - Other Cooking Items (eg Toaster, Kettle, elec frying pan)", 
                      "93 - Hot Ashes, Embers, Spark", "52 - Florescent Lamp (includes ballast)", 
                      "64 - Chemical Processing Equipment (eg. reactors, distilling units, etc.)", 
                      "43 - Clothes Dryer", "69 - Other Processing Equipment", 
                      "88 - Multiple Ignition Source or Igniting Equipment (suspected arson)", 
                      "75 - Matches (open flame)", "32 - Water Heater", 
                      "26 - Terminations-Copper (incl receptacles, switches, lights)", "85 - Vehicle collision", 
                      "28 - Cord, Cable for Appliance, Electrical Articles", "16 - Deep Fat Fryer", 
                      "59 - Other Lighting Equipment", "30 - Other Electrical Distribution Item", 
                      "76 - Lighters (open flame)", "33 - Space Heater - Fixed", "42 - Television, Radio, Stereo, Tape Recorder, etc.", 
                      "39 - Chimney - Masonry", "34 - Space Heater - Portable", "44 - Iron, Pressing Machine", 
                      "108 - Exposure, source other", "15 - Range Hood", "63 - Painting Equipment", 
                      "107 - Exposure, source vehicle (outside structure)", 
                      "104 - Exposure, source open fire (inc campfire, rubbish fire)", 
                      "48 - Air Conditioner - Window or Room Unit", "96 - Chemical Reaction (eg. spontaneous combustion, etc.)", 
                      "106 - Exposure, source grass, shrubs, trees", "35 - Fireplace - Factory Built", 
                      "37 - Fireplace Insert", "94 - Static Electricity (spark)", "9990 - Under Investigation", 
                      "31 - Central Heating/Cooling Unit", "56 - Halogen Lamp or light", 
                      "91 - Fireworks", "46 - Electric Blanket, Heating Pad", 
                      "105 - Exposure, source forest, trees, wildland", "100 - Outdoor fireplace/heater", 
                      "103 - Exposure, source outside storage container, tank", 
                      "38 - Chimney - Factory Built", "54 - Lamp (eg. coal, oil, naphtha, etc.)", 
                      "102 - Exposure, source structure semi-detached or attached", "40 - Flue Pipe", 
                      "27 - Terminations-Aluminum (incl receptables, switches, lights)", 
                      "22 - Meter", "80 - Portable generator", "101 - Exposure, source structure detached", 
                      "95 - Lightning", "97 - Rekindle", "45 - Washing Machine", 
                      "25 - Circuit Wiring - Aluminum", "53 - Christmas Lights, Decorative Lighting", 
                      "61 - Incinerator", "90 - Explosives")

# Create a function to categorize sources
categorize_ignition_sources <- function(source) {
  # Lighting and Electrical Equipment
  if (grepl("Lamp|Lighting|Electrical|Cable|Wire|Ballast|Transformer", source)) {
    return("Lighting and Electrical Equipment")
  } 
  # Cooking and Heating Equipment
  else if (grepl("Stove|Oven|Microwave|Grill|Fryer|Heater|Range", source)) {
    return("Cooking and Heating Equipment")
  } 
  # Fire-related and Open Flame
  else if (grepl("Fire|Matches|Candle|Flame|Torch|Burner|Smoker", source)) {
    return("Fire-related and Open Flame")
  } 
  # Flammable Materials and Chemicals
  else if (grepl("Chemical|Explosion|Flammable|Rekindle|Static|Spark", source)) {
    return("Flammable Materials and Chemicals")
  } 
  # Mechanical Equipment
  else if (grepl("Mechanical|Vehicle|Collision|Smokers|Blower", source)) {
    return("Mechanical Equipment")
  } 
  # Electrical Distribution and Utility
  else if (grepl("Distribution|Service|Utility|Panel|Circuit", source)) {
    return("Electrical Distribution and Utility")
  } 
  
  # Static Electricity and Sparks
  else if (grepl("Spark|Static", source)) {
    return("Static Electricity and Sparks")
  } 
  # Exposure to Fire and Environmental
  else if (grepl("Exposure|Outside|Container|Fireplace|Campfire|Wildland", source)) {
    return("Exposure to Fire and Environmental")
  } 
  # Processing Equipment (Industrial)
  else if (grepl("Furnace|Kiln|Processing|Incinerator", source)) {
    return("Processing Equipment")
  } 
  # Appliances
  else if (grepl("Appliance|Refrigerator|Washing Machine|Dryer|Iron", source)) {
    return("Appliances")
  } 
  
  # Vehicle and Accidents
  else if (grepl("Vehicle|Accident|Collision", source)) {
    return("Vehicle and Accidents")
  } 
  # Multiple Ignition Sources (or suspected arson)
  else if (grepl("Multiple|Arson", source)) {
    return("Multiple Ignition Sources")
  } 
  # Cooling and Air Conditioning Equipment
  else if (grepl("Cooling|Air Conditioner", source)) {
    return("Cooling and Air Conditioning Equipment")
  } 
  # Other (for anything that doesn't fit into the above categories)
  else {
    return("Other")
  }
}
# Apply the categorization function to each ignition source
fire_data$ignition_source_grouped <- sapply(fire_data$ignition_source, categorize_ignition_sources)
#Table
#Plot
# Plot of grouped ignition source distribution
ggplot(fire_data, aes(x = ignition_source_grouped)) +
  geom_bar(fill = "green") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  xlab("Ignition Source Group") +
  ylab("Frequency") +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5)

```

**Understanding Potential Indicators of Severity and Their Replashioships**:\
To explore the relationship between financial losses and casualties, incidents were grouped into financial loss and casualty categories. A heatmap below (@fig-financial-loss-vs-casualties-heatmap) illustrates the interaction between these two indicators.

```{r}
#| label: fig-financial-loss-vs-casualties-heatmap
#| fig-cap: Heatmap illustrating the relationship between financial loss and casualty groups in fire incidents. The plot categorizes incidents based on financial loss and total casualties, with the color intensity representing the frequency of incidents in each combination of loss and casualty group. This provides insights into the severity of fire incidents, highlighting areas with higher financial losses and casualties. We can see that there are greater anount in 1k -10k region.
#| echo: false
#| warning: false

## Financial loss vs. Casualties ##
fire_data$total_casualties <- fire_data$civilian_casualties + fire_data$tfs_firefighter_casualties

#heatmap
fire_data <- fire_data |>
  mutate(
    loss_group = cut(
      estimated_dollar_loss,
      breaks = c(0, 1000, 10000, 50000, 500000, Inf),
      labels = c("<1k", "1k-10k", "10k-50k", "50k-500k", ">500k"),
      right = FALSE
    ),
    casualty_group = cut(
      total_casualties,
      breaks = c(0, 1, 2, 5, Inf),
      labels = c("0", "1", "2-5", ">5"),
      right = FALSE
    )
  )

severity_table <- fire_data |>
  group_by(loss_group, casualty_group) |>
  summarize(count = n())

ggplot(severity_table, aes(x = loss_group, y = casualty_group, fill = count)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  labs(
    x = "Financial Loss Group",
    y = "Casualty Group",
    fill = "Incident Count"
  ) +
  theme_minimal()

```

The scatter plot below showcases the relationship between the number of responding apparatuses and the logarithmic scale of financial losses (@fig-responding-apparatus-vs-log-dollar-loss). We can observe a slight trend between responding apparatus and financial loss A Pearson correlation coefficient was calculated to assess the strength of this relationship.

```{r}
#| label: fig-responding-apparatus-vs-log-dollar-loss
#| fig-cap: Scatter plot showing the relationship between the number of responding apparatus and the log-transformed financial loss in fire incidents. Each point represents a fire incident, with the x-axis displaying the log of the financial loss (with a 1 added for stability) and the y-axis showing the number of responding apparatus. There is a slight trend observed, indicating potential relationship.
#| echo: false

fire_data$Log_Dollar_Loss <- log(fire_data$estimated_dollar_loss + 1)

# Scatter plot between number of responding apparatus and final dollar loss
ggplot(fire_data, aes(y = number_of_responding_apparatus, x = Log_Dollar_Loss)) +
  geom_point(color = 'blue', alpha = 0.5) +
  labs(
       x = 'Number of Responding Apparatus',
       y = 'Log of Final Dollar Loss') +
  theme_minimal()

# cor(fire_data$Log_Dollar_Loss, fire_data$number_of_responding_apparatus, use = "complete.obs")

```

# Model {#sec-model}

## Define Severity

The severity of fire incidents was categorized based on three key factors: the number of responding fire apparatus, the estimated dollar loss, and the total number of casualties. First, the total number of responding apparatus from TFS was calculated and divided into bins after plotting and observing its distribution. Each incident was assigned to a bin based on how many apparatus responded, helping categorize incidents in terms of the scale of response.

Next, the estimated dollar loss for each fire incident was log-transformed. This was necessary because the data was extremely right-skewed, with highly influential outliers. The transformation compressed the scale of the data and managed extreme values better. The transformed data was stored in a new variable called `log_estimated_dollar_loss`. Quantiles (25th, 50th, 75th percentiles) were used to divide the dollar loss into categories to make severity thresholds more meaningful.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false

fire_data_model <- read_parquet( file = here::here("data/02-analysis_data/severity_tfs_analysis_data.parquet"))

```

For casualty severity, the number of casualties, including civilians and firefighters, was categorized after observing its distribution. The categories were defined as:

-   Low: No casualties

-   Medium: 1 to 3 casualties

-   High: 4 or more casualties

Another key factor was the incident type. If the type of incident was determined to be an explosion, it was automatically classified as High Severity regardless of other factors. The final severity of fire incidents was determined based on the following logic:

-   If the incident type was an explosion, the severity was **High**.

-   If casualty severity was "Low," apparatus used was in the lower bins (1-10 apparatus), and dollar loss was below the 25th percentile, the severity was **Low**.

-   If casualty severity was "Medium," apparatus was in the mid-range (11-30 apparatus), or dollar loss was below the 50th percentile, the severity was **Medium**.

-   If casualty severity was "High," apparatus response was in the higher bins (31-50 apparatus), or dollar loss was above the 50th percentile, the severity was **High**.

The analysis shows that most incidents fall under the Low Severity category (see @tbl-severity-count), which aligns with the reality of everyday fire service responses.

```{r}
#| label: tbl-severity-count
#| tbl-cap: The table shows the distribution of fire incidents across Low, Medium, and High severity levels based on the number of responding apparatus, estimated dollar loss, and total casualties and incident type. Notice that there are musch more lower severe incidence.
#| echo: false
#| warning: false
#### Workspace setup ####
library(tidyverse)
library(rstanarm)
library(rpart)
library(ggplot2)
library(dplyr)
library(tidyr)
library(fitdistrplus)
library(knitr)

#### Read data ####
fire_data_model <- read_parquet(file = here::here("data/02-analysis_data/updated_tfs_analysis_data.parquet"))

#### Quantify Severity ####

### Apparatus
fire_data_model <- fire_data_model |>
  mutate(severity_bin = cut(number_of_responding_apparatus,
                            breaks = c(0, 10, 20, 30, 40, 50, Inf),
                            labels = c("[1,10]", "[11,20]", "[21,30]", "[31,40]", "[41,50]", ">50"),
                            right = TRUE))
severity_dist <- fire_data_model |>
  group_by(severity_bin) |>
  summarise(frequency = n()) |>
  ungroup()
#severity_dist


### Estimated_dollar_loss
# Log transform: 
fire_data_model$log_estimated_dollar_loss <- log(fire_data_model$estimated_dollar_loss + 1)
# Recalculate quantiles on transformed data
loss_quantiles <- quantile(fire_data_model$log_estimated_dollar_loss, probs = c(0.25, 0.5, 0.75))

### Determining Severity
fire_data_model <- fire_data_model |>
  mutate(
    # Define Casualty Severity
    casualty_severity = case_when(
      total_casualties == 0 ~ "Low", 
      total_casualties >= 4 ~ "High",
      TRUE ~ "Medium"
    ),
    
    # Define Final Severity based on Apparatus, Dollar Loss, and Casualties
    Severity = case_when(
      # Explosion = High severity
      final_incident_type == 
        "02 - Explosion (including during Fire, excluding Codes 3 & 11-13)"
      ~ "High", 
      
      # Apparatus severity classifications based on bins
      (casualty_severity == "Low" 
       | severity_bin %in% c("[1,10]") 
       | log_estimated_dollar_loss <= loss_quantiles[1]) ~ "Low",
      
      (casualty_severity == "Medium" 
       | severity_bin %in% c("[11,20]", "[21,30]") 
       | log_estimated_dollar_loss <= loss_quantiles[2]) ~ "Medium",
      
      (casualty_severity == "High" 
       | severity_bin %in% c("[31,40]", "[41,50]", ">50") 
       | log_estimated_dollar_loss > loss_quantiles[2]) ~ "High",
      
      TRUE ~ "Low" 
    )
  )
severity_count_table <- fire_data_model |>
  count(Severity)

# Display the table
kable(severity_count_table)
```

## Set Up Model For Predicting Severities

In this analysis, I aimed to predict the likelihood of high-severity fire incidents using a logistic regression model. The dataset includes several predictor variables that show potential connections to fire incident severities, as identified during prior data visualization. Among these variables, `area_of_origin_grouped` and `ignition_source_grouped` are categorical variables representing the area where the fire started and the source of ignition, respectively. The target variable for the model is the binary classification of fire severity, focusing on predicting high-severity incidents.

To prepare the target variable, the `severity` variable calculated earlier was transformed into a binary variable called `Severity_high`, where incidents classified as "High Severity" were coded as `1`. This binary transformation aligns with the analysis goal of predicting high-severity incidents. Since both predictor variables are categorical, they were converted into factors to ensure compatibility with logistic regression. Additionally, redundant spaces and commas in the variable names were cleaned to standardize the data and improve model interpretability.

To evaluate model performance, the dataset was split into a training set (80%) and a testing set (20%) using the `createDataPartition()` function from the `caret` package in R [@citeR].

## Model Explnation

A logistic regression model was chosen because the outcome variable, Severity_high, is binary (0/1), and logistic regression is well-suited for binary classification tasks, especially when working with categorical predictor variables. The logistic regression model used the following predictors. The logistic regression model was initially fitted to the training dataset using the formula: ***Severity_high \~ area_of_origin_grouped + ignition_source_grouped.*** This initial model can be expressed as:

$$
\text{logit}(P) = \ln\left(\frac{P}{1-P}\right) = \beta_0 + \sum_{j=1}^{n_{\text{area}}} \beta_{j,\text{area}} \cdot X_{j,\text{area}} + \sum_{k=1}^{n_{\text{ignition}}} \beta_{k,\text{ignition}} \cdot X_{k,\text{ignition}}
$$

Where: $P$ is the probability of the event: $P(\text{Severity\_high}=1)$.\
$\text{logit}(P)$ is the log-odds of the probability.\
$\beta_0$ is the intercept.\
$\beta_1, \beta_2, \dots, \beta_k$ are the coefficients of the predictor variables $X_1, X_2, \dots, X_k$.

## Model Justification

The initial logistic regression model was evaluated for the significance of the predictors using the p-values from the model summary. Since a high p-value suggests that the variable does not significantly contribute to the model in prediction, it was removed to simplify the model and improve interpretability. This decision follows the principle outlined by Occam's Razor [@blumer1987occam], which proposes that people prefer simplicity.

To check for multicollinearity among the predictors, the Variance Inflation Factor (VIF) was calculated. According to standard practice, if any predictors had a high VIF (greater than 5), they were considered for removal to avoid multicollinearity, which could distort the model's estimates [@alin2010multicollinearity].Based on the results, the variable `ignition_source_grouped` was removed from the model due to its non-significance (high p-value). The updated model retained only `area_of_origin_grouped`, which showed a significant relationship with the likelihood of high-severity fires. Model is:

$$
\text{logit}(P) = \ln\left(\frac{P}{1-P}\right) = \beta_0 + \sum_{j=1}^{n_{\text{area}}} \beta_{j,\text{area}} \cdot X_{j,\text{area}}
$$

The model's performance was also assessed using the Akaike Information Criterion (AIC), a measure of the model's goodness of fit. A lower AIC indicates a better-fitting model, and removing the insignificant variable `ignition_source_grouped` improved the AIC, providing more evidence that the updated, simpler model was a better fit for the data.

## Model Evaluation

The updated logistic regression model was evaluated using the receiver operating characteristic (ROC) curve, with predictions made on the test dataset. The curve was plotted to assess the model’s ability to discriminate between high and low-severity fire incidents. The area under the curve (AUC) is a key metric for model performance; higher AUC values indicate better model performance [@metz1978basic]. The simpler model, after removing insignificant predictors, combined with its performance on the test set, provides a better understanding of the relationship between fire characteristics and severity.

# Results {#sec-results}

## Logistic Regression Model Results

The logistic regression model was fitted to predict the probability of high severity fire incidents based on the categorical variables **area of origin**. The final model keep only significant predictors based on p-values and col-linearity diagnostics. below is a summary ( see @fig-logisticresults-summary) of the model's estimates. The coefficients of each predictor. And Also included other information about model evaluation. It's noticeable that RMSE is not ideal, but this is already an improvement from the initial model.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-logisticresults-summary
#| fig-cap: "Table showing the summary of logistic regression model estimates for predicting fire severity. The table includes coefficients for each significant predictor, their standard errors, z-values, and associated p-values. Significant predictors are highlighted, with p-values less than 0.05 indicating statistical significance. The results provide insights into the relationship between 'Area of Origin' and the likelihood of high-severity fire incidents."

library(rstanarm)
library(modelsummary)
library(tidyverse)
library(dplyr)
library(caret)
library(xgboost)
library(kableExtra)


fire_data_model <- read_parquet(file = here::here("data/02-analysis_data/severity_tfs_analysis_data.parquet"))


#### Prepare Data ####

fire_data_model <- fire_data_model |>
  mutate(Severity_high = as.factor(ifelse(Severity == "High", 1, 0)))

fire_data_model <- fire_data_model[, c(
  "area_of_origin_grouped", 
  "ignition_source_grouped", 
  "Severity_high"
)]

fire_data_model$ignition_source_grouped <- as.factor(fire_data_model$ignition_source_grouped)
fire_data_model$area_of_origin_grouped <- as.factor(fire_data_model$area_of_origin_grouped)

fire_data_model$ignition_source_grouped <- gsub(" ", "_", fire_data_model$ignition_source_grouped)
fire_data_model$area_of_origin_grouped <- gsub(",", "_", fire_data_model$area_of_origin_grouped)
fire_data_model$area_of_origin_grouped <- gsub(" ", "_", fire_data_model$area_of_origin_grouped)
fire_data_model$area_of_origin_grouped <- gsub("__", "_", fire_data_model$area_of_origin_grouped)


trainIndex <- createDataPartition(fire_data_model$Severity_high, p = 0.8, list = FALSE)
train_data <- fire_data_model[trainIndex, ]
test_data <- fire_data_model[-trainIndex, ]



logistic_model <-
  readRDS(file = here::here("models/logtsic_model.rds"))

# Get the summary directly from the stanreg model
logistic_summary <- summary(logistic_model)

# Access the coefficients table
coefficients_table <- logistic_summary$coefficients

# Print or work with the coefficients
kable(coefficients_table)
```

The estimated coefficients for the significant predictor (`area_of_origin`) are visualized to interpret the relative influence of different categories below (@fig-logesiticresults). We can tell most categories are relative to the severity of fire incidence. For example, Fire from mechanical, HVAC, and electrical Areas are highly contributing to the occurrence of ore sever fire incidence.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-logesiticresults
#| fig-cap: Bar plot of the logistic regression coefficients for the 'Area of Origin' variable, showing the effect of each location within a structure where the fire started on the severity of fire incidents. Positive coefficients suggest a higher likelihood of a high-severity fire in that area, while negative coefficients indicate a lower likelihood For example, the Electrical area is related to more severe fire incidence.


library(rstanarm)

logistic_model <-
  readRDS(file = here::here("models/logtsic_model.rds"))

library(ggplot2)
coef_df <- data.frame(
  Area_of_Origin = names(coef(logistic_model))[-1],
  Coefficients = coef(logistic_model)[-1]
)

# Bar plot of coefficients
ggplot(coef_df, aes(x = reorder(Area_of_Origin, Coefficients), y = Coefficients)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(
    x = "Area of Origin",
    y = "Coefficient Value"
  ) +
  theme_minimal()

```

The ROC curve demonstrates the trade-off between the true positive rate (sensitivity) and false positive rate (1-specificity) for the logistic regression model. A higher AUC value signifies better predictive accuracy [@metz1978basic]. In this case, the curve is above the diagonal line and towards the left corners (@fig-logesiticresults-roc), indicating it's a meaningful model for prediction.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-logesiticresults-roc
#| fig-cap: ROC curve for logistic regression model showing the trade-off between the true positive rate and false positive rate. This roc graph indicate model favor more False Negative.

 
library(pROC)
predicted_probs <- predict(logistic_model, test_data, type = "response")
roc_curve <- roc(test_data$Severity_high, predicted_probs)
plot(roc_curve)
```

Therefore, `area_of_origin` is indeed a significant predictor of fire severity, better from it's initial model performance from comparison of AIC scores.

## Fire infrastructure

There is no doubt that infrastructure such as fire alarm and sprinkler systems play a crucial role in controlling fire severity. The presence of these systems will reduces the risk and impact of fires. However, the key question remains: how well do these fire safety infrastructures perform in real fire incidents? We come across result of question by looking at the result we get from analyzing the data set. In this analysis, I processed the data and visualized the distribution of fire alarm system operations and sprinkler system presence across different levels of fire severity (Low, Medium, High). These visualizations provide valuable insights into how the presence of these systems correlates with the severity of fire incidents.

### Fire Alarm System Status

The results shown from the exploration of the proportion of fire alarm system statuses by severity (@fig-firealarmsystem-proportion) reveal that the fire alarm system was successfully operated during many low to medium severity fire incidents. However, it did not perform as reliably in high severity cases. It is important to note that the y-axis represents the proportion, and considering that high-severity incidents are much less frequent, their proportion might not be as large in comparison to the number of incidents. Nevertheless, this comparison provides useful insights, as we never want the system to fail when a real, highly severe incident occurs. This allows for a clearer understanding of how alarm system functionality varies. It is evident that our fire alarm system needs improvement in its operation during actual fire events.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-firealarmsystem-proportion
#| fig-cap: This shows a proportional distribution of fire alarm system operation status across different fire severity levels (Low, Medium, High). This stacked bar plot shows the relative frequencies of various fire alarm system operations within each severity group. We noctice that fire alarm was not always operated in high severity incidents, but not active in low severity fire.

library(tidyverse)
library(rstanarm)
library(rpart)
library(ggplot2)
library(dplyr)
library(tidyr)

fire_data_current <- read_parquet( file = here::here("data/02-analysis_data/severity_tfs_analysis_data.parquet"))

#### fire_alarm_system_operation ####

fire_data_current <- fire_data_current |>
  mutate(
    Severity = factor(Severity, levels = c("Low", "Medium", "High")),
    fire_alarm_system_operation = factor(fire_alarm_system_operation) 
  )

top_fire_alarm_system_operation <- fire_data_current |>
  group_by(Severity, fire_alarm_system_operation) |>
  tally() |>
  group_by(Severity) |>
  top_n(5, n) |>
  ungroup()

# Filter the dataset to include only the Operation of alarm for each severity
fire_operation_data_filtered <- fire_data_current |>
  semi_join(top_fire_alarm_system_operation, by = c("Severity", "fire_alarm_system_operation"))

ggplot(fire_operation_data_filtered, aes(x = Severity, fill = fire_alarm_system_operation)) +
  geom_bar(position = "fill", stat = "count") + 
  labs(
    x = "Severity",
    y = "Proportion",
    fill = "fire_alarm_system_operation"
  ) +
  scale_y_continuous(labels = scales::percent) + 
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5), 
    strip.text = element_text(size = 12)
  )  
```

### Sprinkler System Status

As shown in (@fig-sprinklersystem), I have plotted the presence of the sprinkler system across different levels of fire severity. The operational status of the sprinkler system is represented by various colors corresponding to statuses such as "Full sprinkler system present," "Partial sprinkler system present,". The results reveal that in High severity incidents, the "Undetermined" status is more common, indicating there may be a lack of clarity or understanding regarding the sprinkler system's functionality. In Low severity incidents, the sprinkler system is most frequently reported as absent ("No sprinkler system"). In fact, this absence is the dominant status across all three levels of severity. This suggests that improvements in sprinkler system availability and implementation should be a focus for the future, particularly in higher severity fire scenarios, where the system's functionality could play a critical role in preventing further negative impact.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-sprinklersystem
#| fig-cap: This joint set of three plots illustrates the distribution of sprinkler system presence across different fire severity levels (Low, Medium, High). Different colors represent the various operational statuses of the sprinkler system. The results emphasize the varying presence and functionality of sprinkler systems, showing that, on average, the sprinkler system did not operate across all levels of fire severity.

#### sprinkler_system_presence ####

# Convert Severity and sprinkler_system_data_filtered to factors
fire_data_current <- fire_data_current |>
  mutate(
    Severity = factor(Severity, levels = c("Low", "Medium", "High")),
    sprinkler_system_presence = factor(sprinkler_system_presence)  # Convert ignition_source_grouped to factor
  )

# Calculate the top 5 Status of Sprinkler System for each Severity group
top_sprinkler_system_presence <- fire_data_current |>
  group_by(Severity, sprinkler_system_presence) |>
  tally() |>
  group_by(Severity) |>
  top_n(5, n) |>
  ungroup()

# Filter the dataset to include only the top Status of Sprinkler System for each severity
sprinkler_system_data_filtered <- fire_data_current |>
  semi_join(top_sprinkler_system_presence, by = c("Severity", "sprinkler_system_presence"))


## Three Separate Plot
ggplot(sprinkler_system_data_filtered, aes(x = sprinkler_system_presence, fill = sprinkler_system_presence)) +
  geom_bar() +  
  facet_wrap(~ Severity, scales = "free_y") + 
  labs(
    x = "sprinkler_system_presence",
    y = "Count",
    fill = "sprinkler_system_presence"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
    strip.text = element_text(size = 12),  # Adjust facet label size
    legend.position = "bottom"  # Place the legend at the bottom
  )





```

# Discussion {#sec-discussion}

## Trade-off between False Positives and False Negatives {#sec-first-point}

From the ROC curve, we can tell that it minimizes false negatives more in focus. Putting back into our context of fire severity production, It would be less harmful to tolerate some false positives ( over-predicting the severity of fire); in order not to miss any positive cases (when real severe fire incidents came).

In fact, the cost of missing high-severity fires is far greater than the cost of false positives. While false positives may lead to overreaction, failing to detect a severe fire could escalate into a major disaster, resulting in significant financial losses and potentially causing more casualties. Therefore, a model that is tuned to minimize false negatives is preferable, as it prioritizes catching severe fires—even at the expense of some false positives. However, I will continue to fit additional models to strike a better balance between specificity and sensitivity.

## Limitations and Biases in the Data {#sec-second-point}

### Potential Bias

The fire incidence dataset includes several categorical variables such as Ignition Source, Possible Cause, and Initial Types. During data collection, these variables, which have a limited range of categories, may introduce various types of bias.

1.  **Classification Bias**: Classification bias occurs when events are mis-classified into categories that do not accurately represent the event itself [@brogden1950theory]. This leads to incorrect or misleading conclusions. For example, in the dataset, there is a variable called Possible_Cause, which has over 100 categories, including categories like "Undetermined" and "Suspected Vandalism." When categorizing causes into these categories, ambiguity arises. There may not be enough evidence to definitively classify a cause, and this uncertainty can result in bias. If we were to generalize these 100 causes into fewer categories for prediction purposes, one of the generalized categories could be biased, misrepresenting the actual distribution of causes. This is one of the reasons why I decided to remove this variable from the dataset, besides the fact that it contains many missing values (NAs).
2.  **Selective Reporting Bias**: Reporting bias occurs when data does not accurately reflect reality due to incomplete reporting [@saini2014selective]. In our case, this is particularly relevant for civilian and firefighter casualties related to different fire incidents. It's possible that some fire incidents are not reported, especially smaller ones that don't require significant resources. On the other hand, large, tragic fire incidents are often over-reported or emphasized more than necessary. As a result, the reported number of casualties may be skewed. These discrepancies in the data can affect the definition of what is considered a "severe" fire. If we use these skewed measurements to make predictions or draw conclusions, the resulting insights may be biased.

Due to these biases, the quality of the data depends heavily on how the original data collectors set up their categorization systems. It's crucial to ensure that these systems are designed to capture sufficient and accurate data. By acknowledging the existence of classification and reporting biases, we can avoid overly relying on conclusions and predictions that may be skewed by these factors. Fire incidents, by nature, have risks that should be carefully accounted for in the data collection process to ensure more reliable results.

### Sampling Method in the Data

The fire incident dataset comes from the Ontario Fire Marshal (OFM) and includes incidents to which the Toronto Fire Service (TFS) responded. This data collection is not random, as it is not based on surveys or experimental studies. Instead, it is observational data collected by a specific organization. This can be considered **event-based sampling**.

Event-based sampling is a technique where data is collected when certain events occur, meeting predefined criteria [@sanchez2009application]. This is different from systematically collecting data over a fixed time frame. In this case, data are recorded for every fire incident recognized by the OFM, with each fire incident treated as an event. Event-related data, such as the reason for the fire, time of occurrence, and the TFS's response actions, are recorded.

This is a **non-random sampling method**, meaning that events are not randomly selected from the entire population[@brislin1971non]. Here, the data is gathered based on the occurrence of specific events. As a result, the data may be skewed by the types of incidents that happen to be recorded. For example, areas with higher risks of fires, such as electrical factories according to our modelling, are more likely to be included in the dataset due to the higher frequency of fire incidents in these locations. Therefore, while the dataset provides valuable insights, it is important to acknowledge that the data are not randomly selected, which could introduce bias in the conclusions or predictions drawn from the dataset.

### Privacy Protection in the Data

The fire incident dataset contains real, sensitive data collected from residents in Toronto. Therefore, it is essential to understand how the data is protected to ensure confidentiality.

1.  **Excluded Data:** As mentioned on the data portal, some data have been excluded from the dataset to protect the privacy of individuals. This might explain why there are fewer high-severity cases in the dataset. For more severe incidents, it is more likely that the information could be recognized by the public, as media coverage and news publications often spread the details. As a result, these incidents may be easier to trace back to specific individuals or locations. To protect privacy, such data have been removed. However, this exclusion creates a natural incompleteness in the dataset, as these important and representative data cases, especially important to predict high severity, are no longer available for analysis.

2.  **Aggregated Geographical Data**: Even though the study does not directly analyze fire incidents by district, geographical information remains important. To further protect privacy, the data collectors have aggregated exact locations into broader regions, such as large intersections or general areas. While this approach preserves privacy, it may introduce challenges for spatial analysis. Spatial analysis heavily relies on precise location data, so the aggregation of location information can limit the ability to perform detailed spatial studies and may affect the accuracy of geographical insights.

## Government and Agency Actions for Improving Fire Safety Infrastructure {#sec-third-point}

As the results from our analysis show, there is a significant need for improvement in both the facilitation and implementation of current fire safety systems. The fire alarm system, for example, demonstrated a good operational response in lower and medium severity incidents but failed to function effectively during high-severity situations. Similarly, sprinkler systems showed varying levels of performance, with a higher proportion of "Undetermined" and "Not applicable" statuses in high-severity incidents. These findings raise concerns, as high-severity fires, although less frequent, have a disproportionately severe impact. It is crucial for relevant agencies to ensure that these systems operate reliably during fire incidents, particularly in high-severity cases. Priority should be given to maintaining fire alarm systems and improving the implementation of sprinkler systems. These measures will be essential for mitigating the risks and impacts of severe fire incidents.

## TFS Decision Making {#sec-fourth-point}

The TFS (fire services) should prioritize decision-making before heading to the fire scene based on the predictor variables identified in the study, ensuring they reach the scene as quickly as possible without missing any high-severity incidents. It's also crucial to ensure the right amount of resources, such as firefighters, are allocated. By focusing on key variables like the area of origin, TFS can allocate resources more effectively.

For example, the analysis of fire data reveals a clear pattern in the area of origin across different severity levels. Looking at the graph (@fig-areaoforigin), we can see that mechanical, HVAC, and electrical areas make up a significant portion of high-severity incidents, which aligns with the modeling results.

Thus, when TFS get reported of a fire, if there is a possibility that the fire originated from these high-risk areas, they should be prepared to deploy additional resources and firefighters to these locations. This proactive approach would not only help in saving civilian lives but also protect the firefighters themselves, ensuring a safer response. Additionally, this strategy would allow for more efficient use of social resources, minimizing the impact of the fire while ensuring a well-coordinated respose.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-areaoforigin
#| fig-caption: This plot shows the proportional distribution of top 5 different areas of origin across various fire severity levels (Low, Medium, High). The stacked bar plot illustrates the relative frequency of areas of origin, with the y-axis representing proportions. Mechanical, HVAC, and electrical areas are more common in high-severity incidents, suggesting these are higher-risk areas in terms of fire severity.

fire_data_model <- read_parquet(here::here("data/02-analysis_data/severity_tfs_analysis_data.parquet"))

#Convert Severity and area_of_origin_grouped to factors
fire_data_model <- fire_data_model |>
  mutate(
    Severity = factor(Severity, levels = c("Low", "Medium", "High")),
    area_of_origin_grouped = factor(area_of_origin_grouped)
  )

# Calculate the top 5 Area of Origins for each Severity group
top_area_of_origin <- fire_data_model |>
  group_by(Severity, area_of_origin_grouped) |>
  tally() |>
  group_by(Severity) |>
  top_n(5, n) |>
  ungroup()

# Filter the dataset to include only the top Area of Origins for each severity
area_data_filtered <- fire_data_model |>
  semi_join(top_area_of_origin, by = c("Severity", "area_of_origin_grouped"))

# Create a stacked bar plot with percentages
ggplot(area_data_filtered, aes(x = Severity, fill = area_of_origin_grouped)) +
  geom_bar(position = "fill", stat = "count") +  # 'fill' makes the bars proportional
  labs(
    x = "Severity",
    y = "Proportion",
    fill = "Area of Origin"
  ) +
  scale_y_continuous(labels = scales::percent) +  # Format y-axis as percentages
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5),  # X-axis label alignment
    strip.text = element_text(size = 12)  # Adjust facet label size
  ) 

```

Using other factors, such as ignition sources (see @fig-ignitionsources), which can potentially be determined before reaching the fire scene, can significantly aid in fire reporting. For example, if it’s reported that the fire originated from electrical units or lightning equipment, there may be a higher likelihood of the incident being severe. Therefore, utilizing this information to make informed decisions will enhance the effectiveness of fire response efforts.

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-ignitionsources
#| fig-cap: This plot shows the top 5 ignition sources for each fire severity level (Low, Medium, High). The bar chart illustrates how different ignition sources contribute to fire severity, with separate plots for each level of severity. For example, fires originating from electrical units or lightning equipment may have a higher chance of being severe incidents. By understanding these patterns, fire reporting can be more effective, allowing for better decision-making and resource allocation.


## Factor of Ignition Source ##
# Convert Severity and ignition_source_grouped to factors
fire_data_model <- fire_data_model |>
  mutate(
    Severity = factor(Severity, levels = c("Low", "Medium", "High")),
    ignition_source_grouped = factor(ignition_source_grouped)  # Convert ignition_source_grouped to factor
  )

# Calculate the top 5 ignition sources for each Severity group
top_ignition_sources <- fire_data_model |>
  group_by(Severity, ignition_source_grouped) |>
  tally() |>
  group_by(Severity) |>
  top_n(5, n) |>
  ungroup()

# Filter the dataset to include only the top ignition sources for each severity
fire_data_filtered <- fire_data_model |>
  semi_join(top_ignition_sources, by = c("Severity", "ignition_source_grouped"))

## Three Separate Plot
ggplot(fire_data_filtered, aes(x = ignition_source_grouped, fill = ignition_source_grouped)) +
  geom_bar() +  # Automatically assigns colors based on 'ignition_source_grouped'
  facet_wrap(~ Severity, scales = "free_y") +  # Different y-axis for each facet
  labs(
    x = "Ignition Source Grouped",
    y = "Count",
    fill = "Ignition Source"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
    strip.text = element_text(size = 12),  # Adjust facet label size
    legend.position = "bottom"  # Place the legend at the bottom
  )

```

\newpage

\appendix

# Appendix {.unnumbered}

# Variable Selection and Visualization

```{r}
#| inlcude: false
#| warning: false
#| message: false
#| echo: false
#### Workspace setup ####
library(dplyr)
library(ggplot2)
library(tidyr)
library(lubridate)
library(knitr)


# Since I want to study possible sources leading to different severity of fire, no info about sources should be dropped
clean_data <- clean_data |>
  filter(ignition_source != "999 - Undetermined")

### Ensure Datetime Consistency ###

# Convert timestamps to POSIXct format (YYYY-MM-DD HH:MM:SS)
clean_data$tfs_alarm_time <- ymd_hms(clean_data$tfs_alarm_time)  
clean_data$tfs_arrival_time <- ymd_hms(clean_data$tfs_arrival_time) 
clean_data <- clean_data[!is.na(clean_data$tfs_alarm_time), ]
clean_data <- clean_data[!is.na(clean_data$tfs_arrival_time), ]

```

## Variables Selection Criterion

From this comprehensive dataset which included 43 vairables, I first selected the variables that are most relevant to my topic of study, leaving a total of 17 variables. Variables that are not essential to the study's focus include:

**Geographical Information of Incidence**: The study focuses on analyzing fire data for Toronto as a whole. Geographic details such as the specific station area, ward, or intersection are not critical to determining severity levels. Including these could even divert focus from more relevant variables.

-   `Latitude`, `Longitude`, `Incident_Station_Area`, `Incident_Ward`, and `Intersection`.

**Some Safety System-Related Variables**: The study aims to study some infrasture system suhc as alarm and sprinkler systems. Some variables providing redundant information about these systems were excluded. The dataset also included variables on smoke alarm systems; however, due to the excessive number of null values, these variables were excluded as they made meaningful analysis challenging.

-   `Fire_Alarm_System_Presence`, `Fire_Alarm_System_Impact_on_Evacuation`, `Smoke_Alarm_at_Fire_Origin`, `Smoke_Alarm_at_Fire_Origin_Alarm_Failure`, `Smoke_Alarm_at_Fire_Origin_Alarm_Type`, and `Sprinkler_System_Operation`.

**Repeated Information**: Certain variables contained information that overlapped with variables already chosen for inclusion. To simplify the analysis, these redundant features were removed.

-   `Count_of_Persons_Rescued`, `Estimated_Number_Of_Persons_Displaced`, `Material_First_Ignited`, `Initial_CAD_Event_Type`, `Level_Of_Origin`, `Extent_Of_Fire`, `Status_of_Fire_On_Arrival`, and `Property_Use`.

**Unnecessary Details**: There are detailes in the dataset that is not directly related to the purpose of this study. Incident-specific details, such as how long firefighters took to respond or clear the fire, are more relevant for evaluating operational efficiency. These do not directly contribute to understanding the severity levels.

-   `Ext_agent_app_or_defer_time`, `Fire_Under_Control_Time`, `Last_TFS_Unit_Clear_Time`, `Method_Of_Fire_Control`, and `Incident_Number`.

Upon reviewing the 17 initially selected variables of interest, I observed that some columns contain a significant proportion of missing values (NAs), see @tbl-missing-overview. As a result, certain columns (with more than 20% missing data) should be considered for removal if their relevance to the study topic is not as significant as other variables that should remain.

```{r}
#| label: tbl-missing-overview
#| tbl-cap: This table shows the percentage of missing values for each variable of interest. Variables such as 'area_of_origin,' 'building_status,' and 'business_impact' exhibit high missing percentages, indicating potential areas for further investigation or data imputation, while others like '_id' and 'final_incident_type' have negligible missing values. Understanding these missing values is crucial for the completeness and quality of the analysis..
#| warning: false
#| message: false
#| echo: false
# Missing Value
missing_values <- colSums(is.na(clean_data))
missing_percentage <- round((missing_values / nrow(clean_data)) * 100, 2)
missing_info_table <- data.frame(Missing_Percentage = missing_percentage)
kable(missing_info_table)
```

The variables removed are:

1.  **Building_Status**: This column provides information on the condition of the building, but it is not directly related to the core objectives of the study, which focus on fire severity, casualties, and financial losses. With more than 20% missing data, it was deemed unnecessary.

2.  **Business_Impact**: While this column tracks the impact of the fire on businesses, it overlaps with the **Estimated_Dollar_Loss** column, which provides more comprehensive financial data. Due to the high missing rate, this column was removed.

3.  **Exposures**: This column captures the number of exposure fires but does not directly contribute to understanding fire severity or its impact on casualties and losses. With more than 20% missing data, it was excluded from the analysis.

Kept variables: These variables are essential for the completeness of the analysis. Since all of them are categorical data entries, missing values are replaced with “unreported.”

-   **Fire_Alarm_System_Operation**: This variable is crucial because the study aims to understand fire infrastructure.

-   **Sprinkler_System_Presence**: This is also an important variable for understanding fire safety. Given that there are fewer variables under "Safety Infrastructure," it is essential to retain them.

After dealing with columns with a big proportion of missing values, removing rows with a certain amount of missing values would still remain in a relatively representative dataset. Therefore, I decided to remove any columns with more than 30% missing values to the usability of the dataset fro analysis.

## Distribution and Summary of Cleaned Variables

Below are the plots or summary statistics showing the distribution of all variables of interest in the analysis dataset, after cleaning and removing columns. This includes the created variable 'Response Time.'. The description of each variable is sourced from the data portal in Open Data Toronto \[@TFSfireedata\].

1.  **Area of Origin**: OFM Area of Origin code and description, specifying where the fire started. This information will contribute to the understanding what are some origins of fire and how it may influence fire severity or outcomes. 75 different recorded origins, grouped into 11 larger groups. (see @fig-area-origin-distribution)
2.  **Civilian Casualties**: Count of civilian casualties (injuries or fatalities). This is directly relates to the severity of fire incidents.(see @tbl-civilian-casualties-summary) 
3.  **Estimated Dollar Loss**: Estimated financial loss caused by the fire. This is directly relates to the severity of fire incidents. (see @tbl-estimatedloss)

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: tbl-estimatedloss
#| tbl-cap: The table summarizes the distribution of estimated dollar losses from fire incidents.
library(knitr)

## 3. Estimated Dollar Loss (Numerical) ##
# Overall Table
est_loss_df <- as.data.frame(table(fire_data$estimated_dollar_loss))
colnames(est_loss_df) <- c("Estimated of Loss", "Frequency")
kable(summary(est_loss_df))
# Summary table
# Plot
# (No plot code provided in the original snippet)

```

4.  **Final Incidence Type**: Final classification of the fire incident This can  give information about the nature of the incident, helpful to determine severity. (see @fig-final-incident-type-distribution)
5.  **Fire Alarm System Operation**: Describes the operation of fire alarm systems during the incident. This is important for assessing the role of alarms, this is a part of fire infrastructure.(see @fig-firealarmsystem)

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-firealarmsystem
#| fig-cap: This bar chart shows the distribution of fire alarm system operation types. It highlights the frequency of each type of fire alarm system operation. Operated successfully most of the time.


## 5. Fireground Conditions (Categorical) ##
# Plot
ggplot(fire_data, aes(x = fire_alarm_system_operation)) +
  geom_bar(fill = "blue") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  xlab("Fire Alarm System Operation Type") +
  ylab("Frequency") +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5) 
#Table
#table(fire_data$fire_alarm_system_operation)

```

6.  **Ignition Source**: OFM Ignition Source code and description, detailing how the fire started. This is for understanding factors that contribute to fire ignition (see @fig-grouped-ignition-source-distribution)
7.  **Number of Responding Apparatus**: Number of TFS apparatus that responded to the incident. This may correlate with the severity as it reflects the scale of response. (See @fig-responding-apparatus)

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-responding-apparatus
#| fig-cap: This histogram illustrates the distribution of the number of responding apparatus for fire incidents. The x-axis represents the number of apparatus dispatched, while the y-axis shows the frequency of incidents. The date is right skewed, closer to 1.
## 7. Number of Responding Apparatus (Numerical) ##
ggplot(fire_data, aes(x = number_of_responding_apparatus)) +
  geom_histogram(bins = 30, fill = "cyan", color = "black") +
  theme_minimal() +
  xlab("Number of Responding Apparatus") +
  ylab("Frequency") +
  stat_bin(aes(label = ..count..), geom = "text", vjust = -0.5, size = 3)

```

8.  **Number of Responding Personnel**: Number of TFS personnel that responded to the incident. This reflect the magnitude of resources deployed, could relate with fire’s severity similar as `Number_of_Responding_Apparatus`. (See @fig-responding-personnel-hist)

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-responding-personnel-hist
#| fig-cap: This histogram shows the distribution of the number of responding personnel for fire incidents. The x-axis indicates the number of personnel dispatched, while the y-axis represents the frequency of such incidents. Similar dsitribution as @fig-responding-apparatus. 
# 8. Number of Responding Personnel (Numerical) ##
#Plot
ggplot(fire_data, aes(x = number_of_responding_personnel)) +
  geom_histogram(bins = 30, fill = "yellow", color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  xlab("Number of Responding Personnel") +
  ylab("Frequency") +
  stat_bin(aes(label = ..count..), geom = "text", vjust = 0.5, size = 3)

```

9.  **Possible Cause**: OFM Possible Cause code and description, explaining the potential cause of the fire. This tells the circumstances leading to the fire. (See @tbl-possible-cause-full)

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: tbl-possible-cause-full
#| tbl-cap: Comprehensive table showing all possible fire casues.
## 9. Possible Cause ##
#plot all that has frequency greater than 550
filtered_data <- fire_data |>
  count(possible_cause) |>
  filter(n > 550)
#Full Tabble
cause_table <- table(fire_data$possible_cause)
cause_table_df <- as.data.frame(cause_table) |>
  arrange(desc(Freq))
kable(cause_table_df, col.names = c("Possible Cause", "Frequency"))
```

11. **Sprinkler System Presence**: Describes whether a sprinkler system was present at the location. This provided information of the sprinkler system, which is also a part of fire infrastructure. (see @tbl-sprinkler-system)

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: tbl-sprinkler-system
#| tbl-cap: Table showing the frequency of sprinkler system presence across all fire incidents.

## 11. Sprinkler System Presence (Categorical) ##
#Plot
kable(table(fire_data$sprinkler_system_presence), col.names = c("sprinkler_system_presence", "Frequncy"))

```

12. **TFS Alarm Time**: Time stamp of when TFS was notified of the incident. This useful when analyzing response times and their impact on severity, as well as learning about the amount of incidents across times.(Amount of Fire Incidents by Year, see @fig-fire-incidents-by-year) (Fire Incidents by Month and Year, see @fig-year-month-incident-count)

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-fire-incidents-by-year
#| fig-cap: This bar chart shows the number of fire incidents by year, from 2011 to 2023.
## 12. tfs_alarm_time ## 
fire_data$year <- year(fire_data$tfs_alarm_time)
fire_data$month <- month(fire_data$tfs_alarm_time)
fire_data$month <- as.numeric(fire_data$month)

# Plot Number of Incidents by Year
ggplot(fire_data, aes(x = year)) +
  geom_bar(fill = "lightblue", color = "black") +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5, size = 3) + 
  labs(title = "Fire Incidents by Year", x = "Year", y = "Incident Count") +
  theme_minimal() +
  scale_x_continuous(breaks = seq(min(fire_data$year), max(fire_data$year), by = 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Table


# Print the table
# View(incident_table)
```

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-year-month-incident-count
#| fig-cap: Monthly Incident Count by Year (Excluding 2022 and 2023 becasue from prvious plot, we can see they don't contribute much information)

# from year plot, we can see that 2022 and 2023 does not provide much information so we can droped them.
fire_data_filtered <- fire_data |>
  filter(!is.na(year) & !is.na(month) & month >= 1 & month <= 12)
incident_count_by_year_month <- fire_data_filtered |>
  group_by(year, month) |>
  summarize(count = n(), .groups = 'drop')
incident_count_by_year_month_ex <- incident_count_by_year_month |>
  filter(!(year %in% c(2022, 2023)))
incident_count_by_year_month_ex$month <- factor(incident_count_by_year_month_ex$month, levels = 1:12)
ggplot(incident_count_by_year_month_ex, aes(x = month, y = count)) +
  geom_bar(stat = "identity", fill = "lightcoral", color = "black") +
  labs( x = "Month", y = "Incident Count") +
  scale_x_discrete(
    breaks = 1:12,
    labels = month.name 
  ) +
  facet_wrap(~year, scales = "fixed") +  # Fix the y-axis scale for comparison
  theme_minimal() +
  theme(
    strip.text.x = element_text(size = 10), 
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1.5, size = 8), 
    axis.title.x = element_text(size = 12), 
    axis.title.y = element_text(size = 12), 
    strip.background = element_rect(fill = "lightblue", color = "black"), 
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  )

```

14. **Firefighter Casualties**: Count of TFS firefighter casualties (injuries or fatalities). This is useful when determining the severity of fire. (See @fig-firefighter-casulties)

```{r}
#| echo: false
#| eval: true
#| warning: false
#| message: false
#| label: fig-firefighter-casulties
#| fig-cap: The Pie chart showing the distribution of firefighter casualties, rnaging from 0-3. With being the maximum amount of occurence.

## 14. Firefighter Casualties (Numerical) ##
casualties_table <- table(fire_data$tfs_firefighter_casualties)
casualties_df <- as.data.frame(casualties_table)
# Plot the pie chart
ggplot(casualties_df, aes(x = "", y = Freq, fill = factor(Var1))) +
  geom_bar(stat = "identity", width = 1, color = "black") +
  coord_polar(theta = "y") +
  theme_void() +
  ggtitle("Distribution of Firefighter Casualties") +
  scale_fill_manual(values = c("pink", "lightblue", "lightgreen", "orange")) +
  labs(fill = "Casualties")
#table
#table(fire_data$tfs_firefighter_casualties)
```

15. **Response Time**: This is created variable. It is calculated as the difference between the `TFS_Alarm_Time` (when the fire service is notified of the incident) and the `TFS_Arrival_Time`. (See @fig-response-time-distribution)

\newpage

# References
